# Rocket Todo 重构任务清单

**开始时间**: 2025-11-19T12:45:00.000Z
**分支**: refactoring/service-layer-implementation
**目标**: 实现企业级架构，提升代码质量、可维护性和安全性

## 📋 使用说明

- ✅ **已完成的任务** - 使用 ✅ 标记
- 🔄 **正在进行的任务** - 使用 🔄 标记
- ⏳ **待开始的任务** - 使用 ⏳ 标记
- ❌ **有问题的任务** - 使用 ❌ 标记

每个任务完成后需要：
1. 测试相关功能正常工作
2. 代码审查通过
3. 文档更新完成
4. 提交代码并打勾

---

## 🔴 阶段一：基础架构重构（P0 - 关键任务）

### 1.1 服务层基础架构

#### 1.1.1 创建服务层基础结构
- [ ] ⏳ 创建 `src/services/mod.rs` 模块定义和导出
- [ ] ⏳ 创建 `src/services/error.rs` 统一错误类型定义
- [ ] ⏳ 创建 `src/services/base.rs` 服务层基础接口和trait
- [ ] ⏳ 添加必要依赖到 `Cargo.toml`: `thiserror`, `validator`
- [ ] ⏳ 更新 `src/main.rs` 导入services模块
- [ ] ⏳ 测试服务层基础结构编译通过

#### 1.1.2 实现TodoService
- [ ] ⏳ 创建 `src/services/todo_service.rs` 文件
- [ ] ⏳ 定义TodoService结构和基础方法
- [ ] ⏳ 实现create_todo方法（包含业务逻辑和用户隔离）
- [ ] ⏳ 实现get_todo_by_id方法（包含权限检查）
- [ ] ⏳ 实现get_all_todos方法（包含分页和用户隔离）
- [ ] ⏳ 实现update_todo方法（包含数据验证）
- [ ] ⏳ 实现delete_todo方法（包含权限检查）
- [ ] ⏳ 实现get_todos_by_status方法
- [ ] ⏳ 实现get_todos_by_priority方法
- [ ] ⏳ 实现get_overdue_todos方法
- [ ] ⏳ 实现get_upcoming_todos方法
- [ ] ⏳ 添加输入验证和错误处理
- [ ] ⏳ 编写TodoService单元测试
- [ ] ⏳ 测试TodoService所有方法功能正确

#### 1.1.3 实现UserService
- [ ] ⏳ 创建 `src/services/user_service.rs` 文件
- [ ] ⏳ 定义UserService结构和基础方法
- [ ] ⏳ 实现create_user方法（包含密码哈希）
- [ ] ⏳ 实现authenticate_user方法（包含密码验证）
- [ ] ⏳ 实现get_user_by_id方法
- [ ] ⏳ 实现get_user_by_email方法
- [ ] ⏳ 实现update_user方法
- [ ] ⏳ 实现validate_password_strength方法
- [ ] ⏳ 实现generate_jwt_token方法
- [ ] ⏳ 实现verify_jwt_token方法
- [ ] ⏳ 添加用户数据验证
- [ ] ⏳ 编写UserService单元测试
- [ ] ⏳ 测试UserService所有方法功能正确

#### 1.1.4 实现TagService
- [ ] ⏳ 创建 `src/services/tag_service.rs` 文件
- [ ] ⏳ 定义TagService结构和基础方法
- [ ] ⏳ 实现create_tag方法（包含用户隔离）
- [ ] ⏳ 实现get_tag_by_id方法（包含权限检查）
- [ ] ⏳ 实现get_all_tags方法（包含用户隔离）
- [ ] ⏳ 实现update_tag方法
- [ ] ⏳ 实现delete_tag方法
- [ ] ⏳ 实现add_tag_to_todo方法
- [ ] ⏳ 实现remove_tag_from_todo方法
- [ ] ⏳ 实现get_todo_tags方法
- [ ] ⏳ 实现get_todos_by_tag方法（优化N+1查询）
- [ ] ⏳ 实现get_popular_tags方法
- [ ] ⏳ 编写TagService单元测试
- [ ] ⏳ 测试TagService所有方法功能正确

#### 1.1.5 实现SubtaskService
- [ ] ⏳ 创建 `src/services/subtask_service.rs` 文件
- [ ] ⏳ 定义SubtaskService结构和基础方法
- [ ] ⏳ 实现create_subtask方法（包含用户隔离和父任务验证）
- [ ] ⏳ 实现get_subtask_by_id方法（包含权限检查）
- [ ] ⏳ 实现get_subtasks_by_todo方法（包含用户隔离）
- [ ] ⏳ 实现update_subtask方法
- [ ] ⏳ 实现delete_subtask方法
- [ ] ⏳ 实现reorder_subtasks方法（包含事务处理）
- [ ] ⏳ 实现get_subtasks_by_status方法
- [ ] ⏳ 实现get_overdue_subtasks方法
- [ ] ⏳ 实现get_subtask_progress方法
- [ ] ⏳ 实现validate_subtask_order方法
- [ ] ⏳ 编写SubtaskService单元测试
- [ ] ⏳ 测试SubtaskService所有方法功能正确

#### 1.1.6 服务层集成和测试
- [ ] ⏳ 创建Mock数据库连接用于测试
- [ ] ⏳ 编写服务层集成测试
- [ ] ⏳ 测试服务层错误处理
- [ ] ⏳ 测试用户数据隔离
- [ ] ⏳ 验证服务层性能
- [ ] ⏳ 创建服务层使用文档

### 1.2 统一错误处理系统

#### 1.2.1 创建错误类型定义
- [ ] ⏳ 创建 `src/error/mod.rs` 文件
- [ ] ⏳ 定义AppError枚举（包含验证、业务、系统错误）
- [ ] ⏳ 实现AppError的Display trait
- [ ] ⏳ 实现AppError的std::error::Error trait
- [ ] ⏳ 创建ErrorSource枚举定义错误来源
- [ ] ⏳ 定义ErrorCode枚举标准化错误码
- [ ] ⏳ 创建ErrorResponse结构体定义API错误响应格式
- [ ] ⏳ 实现错误分类和处理函数
- [ ] ⏳ 创建错误追踪和日志记录
- [ ] ⏳ 测试错误类型定义完整性

#### 1.2.2 实现错误处理中间件
- [ ] ⏳ 创建 `src/error/middleware.rs` 文件
- [ ] ⏳ 实现AppError的Rocket Responder trait
- [ ] ⏳ 创建统一错误响应处理函数
- [ ] ⏳ 实现错误日志记录功能
- [ ] ⏳ 实现错误链追踪
- [ ] ⏳ 创建错误监控和报告
- [ ] ⏳ 集成到Rocket框架
- [ ] ⏳ 测试错误中间件功能

#### 1.2.3 更新所有Handler使用新错误系统
- [ ] ⏳ 重构 `todo_handler.rs` 使用AppError
- [ ] ⏳ 重构 `auth_handler.rs` 使用AppError
- [ ] ⏳ 重构 `tag_handler.rs` 使用AppError
- [ ] ⏳ 重构 `subtask_handler.rs` 使用AppError
- [ ] ⏳ 移除旧的错误处理代码
- [ ] ⏳ 统一所有错误响应格式
- [ ] ⏳ 添加错误上下文信息
- [ ] ⏳ 测试所有Handler的错误处理
- [ ] ⏳ 验证错误响应一致性

#### 1.2.4 错误处理测试和文档
- [ ] ⏳ 创建错误处理测试用例
- [ ] ⏳ 测试各种错误场景响应
- [ ] ⏳ 测试错误日志记录
- [ ] ⏳ 创建错误处理使用指南
- [ ] ⏳ 更新API文档中的错误响应

### 1.3 用户数据隔离

#### 1.3.1 数据库架构更新
- [ ] ⏳ 创建数据库迁移 `006_add_user_id_to_todos.sql`
- [ ] ⏳ 创建数据库迁移 `007_add_user_id_to_tags.sql`
- [ ] ⏳ 创建数据库迁移 `008_add_user_id_to_subtasks.sql`
- [ ] ⏳ 创建数据库迁移 `009_create_foreign_key_constraints.sql`
- [ ] ⏳ 创建数据库迁移 `010_add_user_indexes.sql`
- [ ] ⏳ 运行数据库迁移
- [ ] ⏳ 验证数据库结构更新正确

#### 1.3.2 服务层用户隔离
- [ ] ⏳ 更新TodoService所有方法添加user_id参数
- [ ] ⏳ 更新TagService所有方法添加user_id参数
- [ ] ⏳ 更新SubtaskService所有方法添加user_id参数
- [ ] ⏳ 实现数据访问权限检查
- [ ] ⏳ 添加用户数据验证逻辑
- [ ] ⏳ 实现跨用户访问防护
- [ ] ⏳ 测试用户数据隔离功能
- [ ] ⏳ 验证数据隔离完整性

#### 1.3.3 认证中间件更新
- [ ] ⏳ 更新JWT认证中间件提取用户信息
- [ ] ⏳ 实现用户ID到请求上下文传递
- [ ] ⏳ 创建路由级权限检查中间件
- [ ] ⏳ 更新所有需要认证的路由
- [ ] ⏳ 测试认证和授权功能
- [ ] ⏳ 验证权限控制正确性

#### 1.3.4 数据迁移和验证
- [ ] ⏳ 创建数据迁移脚本为现有数据添加用户关联
- [ ] ⏳ 实现数据一致性检查工具
- [ ] ⏳ 执行数据迁移
- [ ] ⏳ 验证数据迁移正确性
- [ ] ⏳ 测试数据迁移回滚
- [ ] ⏳ 创建数据迁移文档

---

## 🟡 阶段二：质量提升重构（P1 - 重要任务）

### 2.1 统一数据验证层

#### 2.1.1 创建验证框架
- [ ] ⏳ 添加 `validator` 和 `regex` 依赖到Cargo.toml
- [ ] ⏳ 创建 `src/validation/mod.rs` 文件
- [ ] ⏳ 实现自定义验证器trait
- [ ] ⏳ 创建业务验证规则函数
- [ ] ⏳ 实现验证错误处理
- [ ] ⏳ 创建验证结果类型
- [ ] ⏳ 测试验证框架功能

#### 2.1.2 实现模型验证
- [ ] ⏳ 为CreateTodoRequest添加验证注解
- [ ] ⏳ 为UpdateTodoRequest添加验证注解
- [ ] ⏳ 为CreateUserRequest添加验证注解
- [ ] ⏳ 为LoginRequest添加验证注解
- [ ] ⏳ 为CreateTagRequest添加验证注解
- [ ] ⏳ 为CreateSubtaskRequest添加验证注解
- [ ] ⏳ 实现复杂业务验证规则
- [ ] ⏳ 集成验证到服务层
- [ ] ⏳ 测试所有验证规则

#### 2.1.3 验证测试
- [ ] ⏳ 创建验证测试用例
- [ ] ⏳ 测试各种验证场景
- [ ] ⏳ 测试验证错误处理
- [ ] ⏳ 测试复杂验证规则
- [ ] ⏳ 验证性能影响最小

### 2.2 配置管理系统

#### 2.2.1 创建配置结构
- [ ] ⏳ 添加 `config` 和 `dotenv` 依赖到Cargo.toml
- [ ] ⏳ 创建 `src/config/mod.rs` 文件
- [ ] ⏳ 定义AppConfig结构体
- [ ] ⏳ 定义DatabaseConfig结构体
- [ ] ⏳ 定义JwtConfig结构体
- [ ] ⏳ 定义ServerConfig结构体
- [ ] ⏳ 定义LogConfig结构体
- [ ] ⏳ 实现配置结构体的序列化

#### 2.2.2 实现配置加载
- [ ] ⏳ 实现从环境变量加载配置
- [ ] ⏳ 实现从配置文件加载配置
- [ ] ⏳ 实现配置验证逻辑
- [ ] ⏳ 实现配置默认值
- [ ] ⏳ 创建配置加载错误处理
- [ ] ⏳ 实现配置热重载（可选）
- [ ] ⏳ 测试配置加载功能

#### 2.2.3 更新硬编码配置
- [ ] ⏳ 移除main.rs中的硬编码配置
- [ ] ⏳ 移除auth_handler.rs中的硬编码配置
- [ ] ⏳ 使用配置系统替代所有硬编码
- [ ] ⏳ 更新应用启动逻辑
- [ ] ⏳ 创建.env.example文件
- [ ] ⏳ 测试配置系统功能

#### 2.2.4 配置文档和测试
- [ ] ⏳ 创建配置文档
- [ ] ⏳ 测试配置验证
- [ ] ⏳ 测试不同环境配置
- [ ] ⏳ 验证配置系统完整性

### 2.3 分页支持

#### 2.3.1 创建分页结构
- [ ] ⏳ 创建 `src/pagination/mod.rs` 文件
- [ ] ⏳ 定义PaginationParams结构体
- [ ] ⏳ 定义PaginatedResponse结构体
- [ ] ⏳ 实现分页工具函数
- [ ] ⏳ 创建分页验证逻辑
- [ ] ⏳ 测试分页结构

#### 2.3.2 实现分页查询
- [ ] ⏳ 更新TodoService.get_all_todos支持分页
- [ ] ⏳ 更新TagService.get_all_tags支持分页
- [ ] ⏳ 更新SubtaskService.get_subtasks_by_todo支持分页
- [ ] ⏳ 实现高效的分页SQL查询
- [ ] ⏳ 添加分页元数据计算
- [ ] ⏳ 实现游标分页（可选）
- [ ] ⏳ 测试分页查询性能

#### 2.3.3 更新API接口
- [ ] ⏳ 更新所有路由支持分页参数
- [ ] ⏳ 更新API文档添加分页参数
- [ ] ⏳ 保持向后兼容性
- [ ] ⏳ 测试分页接口功能
- [ ] ⏳ 验证分页正确性

---

## 🟢 阶段三：性能优化（P2 - 优化任务）

### 3.1 性能优化

#### 3.1.1 解决N+1查询问题
- [ ] ⏳ 分析所有N+1查询场景
- [ ] ⏳ 重写TagService.get_todos_by_tag使用JOIN
- [ ] ⏳ 优化get_todo_with_subtasks查询
- [ ] ⏳ 批量查询优化
- [ ] ⏳ 测试查询性能提升
- [ ] ⏳ 验证功能正确性

#### 3.1.2 数据库索引优化
- [ ] ⏳ 分析查询模式创建索引
- [ ] ⏳ 创建复合索引优化
- [ ] ⏳ 验证索引效果
- [ ] ⏳ 测试查询性能提升

#### 3.1.3 查询优化
- [ ] ⏳ 优化复杂查询逻辑
- [ ] ⏳ 减少不必要数据传输
- [ ] ⏳ 实现查询结果缓存
- [ ] ⏳ 测试查询优化效果

### 3.2 缓存系统

#### 3.2.1 缓存基础架构
- [ ] ⏳ 添加Redis相关依赖
- [ ] ⏳ 创建 `src/cache/mod.rs` 文件
- [ ] ⏳ 实现CacheService结构体
- [ ] ⏳ 创建缓存操作接口
- [ ] ⏳ 设计缓存键命名策略
- [ ] ⏳ 实现缓存序列化
- [ ] ⏳ 测试缓存基础功能

#### 3.2.2 实现业务缓存
- [ ] ⏳ 缓存用户会话信息
- [ ] ⏳ 缓存用户认证信息
- [ ] ⏳ 缓存高频查询结果（如用户todos）
- [ ] ⏳ 缓存标签信息
- [ ] ⏳ 实现缓存失效策略
- [ ] ⏳ 添加缓存监控指标
- [ ] ⏳ 测试缓存功能

#### 3.2.3 缓存测试和优化
- [ ] ⏳ 测试缓存命中率
- [ ] ⏳ 测试缓存一致性
- [ ] ⏳ 测试缓存性能提升
- [ ] ⏳ 优化缓存策略
- [ ] ⏳ 验证缓存系统稳定性

---

## 🧪 阶段四：测试和验证

### 4.1 单元测试
- [ ] ⏳ 创建服务层单元测试（目标覆盖率 > 90%）
- [ ] ⏳ 创建验证层单元测试
- [ ] ⏳ 创建错误处理单元测试
- [ ] ⏳ 创建配置系统单元测试
- [ ] ⏳ 创建分页功能单元测试
- [ ] ⏳ 运行所有单元测试
- [ ] ⏳ 验证测试覆盖率

### 4.2 集成测试
- [ ] ⏳ 创建API接口集成测试
- [ ] ⏳ 创建数据库集成测试
- [ ] ⏳ 创建认证授权集成测试
- [ ] ⏳ 创建用户数据隔离测试
- [ ] ⏳ 运行所有集成测试
- [ ] ⏳ 验证测试稳定性

### 4.3 性能测试
- [ ] ⏳ 创建数据库查询性能测试
- [ ] ⏳ 创建并发性能测试
- [ ] ⏳ 创建缓存性能测试
- [ ] ⏳ 运行性能基准测试
- [ ] ⏳ 对比重构前后性能
- [ ] ⏳ 验证性能提升目标

### 4.4 安全测试
- [ ] ⏳ 创建用户数据隔离安全测试
- [ ] ⏳ 创建权限控制测试
- [ ] ⏳ 创建输入验证安全测试
- [ ] ⏳ 创建SQL注入防护测试
- [ ] ⏳ 运行所有安全测试
- [ ] ⏳ 验证安全性要求

---

## 📋 最终验收标准

### 功能验收
- [ ] ⏳ 所有现有API功能正常工作
- [ ] ⏳ 新功能按需求正确实现
- [ ] ⏳ 边界条件处理正确
- [ ] ⏳ 错误情况处理合理

### 性能验收
- [ ] ⏳ API响应时间不超过重构前
- [ ] ⏳ 数据库查询效率优化50%+
- [ ] ⏳ 内存使用合理
- [ ] ⏳ 并发处理稳定

### 质量验收
- [ ] ⏳ 代码覆盖率 > 80%
- [ ] ⏳ 单元测试通过率 100%
- [ ] ⏳ 集成测试通过率 100%
- [ ] ⏳ 代码质量检查通过

### 安全验收
- [ ] ⏳ 用户数据隔离完整
- [ ] ⏳ 输入验证全面
- [ ] ⏳ 权限控制正确
- [ ] ⏳ 敏感信息保护

---

## 📊 进度统计

### 总体进度
- [ ] ⏳ 总任务数: 150+ 项
- [ ] ⏳ 已完成: 0 项 (0%)
- [ ] ⏳ 进行中: 0 项 (0%)
- [ ] ⏳ 待开始: 150+ 项 (100%)

### 阶段进度
- [ ] ⏳ 阶段一（基础架构）: 0/75 项 (0%)
- [ ] ⏳ 阶段二（质量提升）: 0/45 项 (0%)
- [ ] ⏳ 阶段三（性能优化）: 0/20 项 (0%)
- [ ] ⏳ 阶段四（测试验证）: 0/15 项 (0%)

---

## 📝 更新日志

| 日期 | 完成任务 | 进度变化 | 备注 |
|------|----------|----------|------|
| 2025-11-19 | 创建重构计划 | 0% | 项目启动 |

---

**使用说明**: 每完成一个任务，请将对应的 `[ ] ⏳` 修改为 `[x] ✅`，并添加完成日期和备注。定期更新进度统计部分。